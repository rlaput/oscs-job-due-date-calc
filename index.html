<!DOCTYPE html>
<html>
  <head>
    <title>Job Due Date Calculator</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      // Dynamic cache busting - load JS files with current timestamp
      function loadScriptWithCacheBusting(src) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          const timestamp = Date.now();
          script.src = `${src}?v=${timestamp}`;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      // Load scripts sequentially to ensure proper order
      async function loadScripts() {
        try {
          await loadScriptWithCacheBusting('servicesLeadTime.js');
          await loadScriptWithCacheBusting('additionalServices.js');
          // Initialize the app after scripts are loaded
          initializeApp();
        } catch (error) {
          console.error('Error loading scripts:', error);
        }
      }

      // Initialize app function
      function initializeApp() {
        // Event handlers
        $("#customerType").on('change', updateServices);
        $("#service").on('change', updateDays);
        $("#calculateBtn").on('click', calculateDates);

        // Initialize
        populateCustomerTypes();
        initializeHolidays();
        generateAdditionalServices();

        // Set default start date to today
        const today = new Date();
        const yyyy = today.getFullYear();
        let mm = today.getMonth() + 1;
        let dd = today.getDate();

        if (dd < 10) dd = "0" + dd;
        if (mm < 10) mm = "0" + mm;

        const formattedToday = yyyy + "-" + mm + "-" + dd;
        $("#startDate").val(formattedToday);
      }

      // Load scripts when DOM is ready
      document.addEventListener('DOMContentLoaded', loadScripts);
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f6f8;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      .container {
        background: #ffffff;
        padding: 30px 40px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 320px;
      }

      h2 {
        margin-bottom: 20px;
        color: #333;
      }

      label {
        display: block;
        margin: 15px 0 5px;
        color: #555;
        font-weight: bold;
        text-align: left;
      }

      select,
      input[type="date"],
      input[type="number"] {
        width: 100%;
        padding: 8px 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
      }

      button {
        background-color: #007bff;
        color: #fff;
        border: none;
        padding: 10px 15px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
      }

      button:hover {
        background-color: #0056b3;
      }

      #result {
        margin-top: 20px;
        color: #007bff;
        font-weight: bold;
        font-size: 25px;
      }

      #deliverBy {
        color: red !important;
        font-weight: normal !important;
        font-size: 20px !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Job Due Date Calculator</h2>

      <label for="customerType">Customer Type:</label>
      <select id="customerType"></select>

      <label for="service">Service:</label>
      <select id="service"></select>
      <div id="serviceHelpText" style="color: green;"></div>

      <label>Additional Services:</label>
      <div id="additionalServicesContainer" style="text-align: left; display: flex; flex-wrap: wrap; gap: 15px;"></div>

      <label for="daysToAdd">Days to Add:</label>
      <input type="number" id="daysToAdd" min="1" />

      <label for="startDate">Start Date:</label>
      <input type="date" id="startDate" />

      <button id="calculateBtn">Calculate</button>

      <h3 id="result"></h3>
    </div>

    <script>
      function generateAdditionalServices() {
        const $container = $("#additionalServicesContainer");
        additionalServices.forEach((service) => {
          const $div = $('<div>').css({
            textAlign: 'left',
            display: 'flex',
            alignItems: 'center'
          });
          
          const $checkbox = $('<input>')
            .attr({
              type: 'checkbox',
              id: service.name + 'Check',
              value: service.name
            })
            .on('change', adjustDays);
          
          const $label = $('<label>')
            .attr('for', service.name + 'Check')
            .text(`${service.name} - ${service.days} day(s)`);
          
          $div.append($checkbox).append($label);
          $container.append($div);
        });
      }

      async function loadHolidays() {
        try {
          const data = await $.getJSON("holidays.json");
          return data;
        } catch (error) {
          console.error('Error loading holidays:', error);
          return [];
        }
      }

      let holidayData = [];

      async function initializeHolidays() {
        holidayData = await loadHolidays();
      }

      function formatDateNZtoISO(nzDate) {
        const [day, month, year] = nzDate.split("/");
        return `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
      }

      async function getHolidayDates() {
        if (holidayData.length === 0) {
          await initializeHolidays();
        }
        return holidayData
          .filter((h) => h.Type === "National")
          .map((h) => formatDateNZtoISO(h.ObservedDate));
      }

      function updateServices() {
        const customerType = $("#customerType").val();
        const $servicesDropdown = $("#service");
        $servicesDropdown.empty();

        const services = servicesLeadTime[customerType] || [];
        services.forEach((service) => {
          $servicesDropdown.append(
            $('<option>').val(service.name).text(service.name)
          );
        });

        updateDays();
      }

      function updateDays() {
        const customerType = $("#customerType").val();
        const service = $("#service").val();
        const customerServices = servicesLeadTime[customerType] || [];
        const selectedService = customerServices.find(
          (s) => s.name === service
        );
        const leadTime = selectedService ? selectedService.productionDays : undefined;

        const $daysInput = $("#daysToAdd");
        $daysInput.val(leadTime || "");
        $daysInput.attr("data-base-days", $daysInput.val());

        const helpText = leadTime ? `Selected service production time is ${leadTime} day(s).` : "";
        $("#serviceHelpText").text(helpText);

        adjustDays();
      }

      function adjustDays() {
        const $daysInput = $("#daysToAdd");
        const baseDays = parseInt($daysInput.attr("data-base-days")) || 
                        parseInt($daysInput.val()) || 0;
        let additionalDays = 0;
        
        additionalServices.forEach((service) => {
          const $checkbox = $("#" + service.name + "Check");
          if ($checkbox.is(':checked')) {
            additionalDays += service.days;
          }
        });
        
        $daysInput.val(baseDays + additionalDays);
      }

      function populateCustomerTypes() {
        const $customerDropdown = $("#customerType");
        Object.keys(servicesLeadTime).forEach((customerType) => {
          $customerDropdown.append(
            $('<option>').val(customerType).text(customerType)
          );
        });
        updateServices();
      }

      // Reusable function to calculate date by adding business days
      async function calculateDate(startDateInput, daysToAdd) {
        let currentDate = new Date(startDateInput);
        let remainingDays = daysToAdd;
        const holidays = await getHolidayDates();

        while (remainingDays > 0) {
          currentDate.setDate(currentDate.getDate() + 1);
          const dateStr = currentDate.toISOString().split("T")[0];
          const isWeekend =
            currentDate.getDay() === 0 || currentDate.getDay() === 6;
          const isHoliday = holidays.includes(dateStr);

          if (!isWeekend && !isHoliday) {
            remainingDays--;
          }
        }

        return new Date(currentDate);
      }

      // Main calculation function called by the Calculate button
      async function calculateDates() {
        const startInput = $("#startDate").val();
        const daysToAdd = parseInt($("#daysToAdd").val());

        if (!startInput || isNaN(daysToAdd)) {
          $("#result").text("Please enter valid values.");
          return;
        }

        // Get the selected service to access deliveryDays
        const customerType = $("#customerType").val();
        const serviceName = $("#service").val();
        const customerServices = servicesLeadTime[customerType] || [];
        const selectedService = customerServices.find(
          (s) => s.name === serviceName
        );

        if (!selectedService) {
          $("#result").text("Please select a valid service.");
          return;
        }

        try {
          // Calculate job ready date using start date and total production days
          const jobReadyDate = await calculateDate(startInput, daysToAdd);
          
          // Calculate delivery date using job ready date and delivery days
          const deliveryDate = await calculateDate(jobReadyDate, selectedService.deliveryDays);

          // Format both dates for display
          const formatDate = (date) => {
            const dd = String(date.getDate()).padStart(2, "0");
            const mm = String(date.getMonth() + 1).padStart(2, "0");
            const yyyy = date.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
          };

          const jobReadyFormatted = formatDate(jobReadyDate);
          const deliveryFormatted = formatDate(deliveryDate);

          $("#result").html(`<p>Job ready by: ${jobReadyFormatted}</p><p id="deliverBy">Delivery by: ${deliveryFormatted}</p>`);
        } catch (error) {
          console.error('Error calculating dates:', error);
          $("#result").text("Error calculating dates. Please try again.");
        }
      }

    </script>
  </body>
</html>
